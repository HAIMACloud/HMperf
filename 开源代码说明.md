HMperf使用说明书
===========
### 介绍
* HMperf是由海马云开发的针对android云游戏的端性能测试和分析工具平台，手机无需ROOT，手机硬件和APP也无需作任何修改，即插即用。
* HMperf支持Android平台所有应用程序（游戏，APP应用，小程序，H5等），Android模拟器，云手机，云游戏等性能测试。
* Windows/Mac OS/Linux平台都支持对Android设备进行测试。


### 目录介绍
* go_romstat 进行性能数据采集的代码目录
  * apk 通过包名获取安装包的具体信息的相关代码
  * build 编译参数
  * stat
    * data基础数据定义
    * piugins 实现采集帧率/带宽/硬件性能的相关代码
    * utils公共支持的方法定义
  * main.go程序入口
* py_start 开始执行和上传测试结果的代码目录
  * start.py 执行测试并采集测试数据
  * uperport.py 上传测试结果生成测试报告
* romstat 可执行的二进制文件


### 编译romstat
* githup地址：
* clone代码后，在根目录执行编译代码

```bash
sh build.sh


```
* 编译完成后会在当前目录生成一个HMperf二进制文件，可以直接在手机中运行

### 编译HMperf
* 添加打包执行文件说明
* 环境依赖：
1. python 3.6以上
2. 安装requests库：``` pip intsall requests```

### 安装及运行

* 操作步骤
* 添加token获取说明
1. 步骤1: 登陆海马云官网https://www.haimacloud.com/，根据您的PC平台下载对应的应用程序。
2. 步骤2：手机开启开发者模式，允许USB调试
3. 步骤3: USB连接手机，使用adb devices命令检查PC是否正常连接手机
4. 步骤4: 使用python执行py文件，开始测试
```bash
python start.py
```
5. 步骤5:   测试完成后使用python执行上传py文件
```bash
python upReport.py
```
6. 步骤6:   登陆HMperf平台查看测试结果

###  命令行参数
* 在执行start.py 和 upReport.py时，可以通过传入devices ID来指定需要测试设备
```
python3 start.py BLT0222907028
```

### 软件性能数据介绍：Android平台

**数据指标说明**
* FPS：1秒内手机画面的真实平均刷新次数，也可以叫做帧率
  1. FPS最小值：一段时间内的最小帧率
  2. FPS平均值：一段时间内的帧率平均值
  3. FPS最大值：一段时间内的最大帧率
* SJank：1s内微小卡顿次数
* Jank：1s内卡顿次数
* BJank：1S内严重卡顿次数
* jT：上下帧画面显示的时间间隔，可以被认为一次卡顿的时长
* cpu：手机整机CPU使用率,汇总显示测试时间内的最小值/最大值/平均值
* mem：手机整机内存使用率
* swap/MB：内存交换分区的大小
* inKB：下载带宽
* outKB：上传带宽
* rtt：测试设备的网络时延
* loss：测试设备的网络丢包数据；注:每秒内测试设备会发送5个数据包，loss显示的数量就表示这秒发送的5个包中丢了几个包，比如是2，如果是loss为0，就说明在这秒中没有发生丢包

### Jank卡顿及stutter卡顿率说明
**HMperf Jank计算方法:**
* 同时满足以下两个条件，则认为是一次卡顿SJank
  1. 当前帧耗时大于前三帧平均帧耗时的2倍
  2. 当前帧耗时大于一帧电影帧耗时（1000ms/24=41ms）
* 同时满足以下两个条件，则认为是一次卡顿Jank
  1. 当前帧耗时大于前三帧平均帧耗时的2倍
  2. 当前帧耗时大于两帧电影帧耗时（1000ms/24*2=83ms）
* 同时满足以下两个条件，则认为是一次严重卡顿BJank
  1. 当前帧耗时大于前三帧平均耗时的2倍
  2. 当前帧耗时大于三帧电影帧耗时（1000ms/24+3=125ms）
* Jank/10min：平均10分钟卡顿次数
* Bjank/10min：平均10分钟严重卡顿次数
* jank算法
  1. HMperf卡顿算法与perfdog保持一致，经过我们的测试两者的卡顿率数据基本一致
  2. 注：在发生一次jank或bigjank后，在当前帧的后三帧，不会重新计算jank；即第1帧帧间隔满足条件被记为jank后，第2，3，4帧都满足jank或bigjank条件时，也不会记为jank
  3. SJank所产生的卡顿时常不会被计入stutter的计算

**帧率/卡顿率原始数据获取说明：**
* 帧率卡顿率使用的基础数据是android系统中SurfaceFlinger的上屏数据时间戳
```bash
dumpsys SurfaceFlinger --latency
```
* 在android系统中执行该命令，可以获取到当前运行程序画面渲染后的上屏时间，通过对上屏时间的计算，可以获取到两帧画面的帧间隔数据；通过对帧间隔数据的计算和处理，就可以计算出帧率和卡顿率
* 卡顿率计算方法，参见上文
* 帧率计算方法：帧间隔等于1000ms时的帧数量
### 云游戏性能标准参考说明
**帧率**
**卡顿率**
* 说一下在云游戏场景下，常见的30/60帧帧率的游戏，在帧率和卡顿率多少数值下会影响游玩的体验
### 数据问题
* 测试结果会以.hm结尾的文件保存在手机目录：/data/local/tmp/下
* 上传测试结果时，最大支持的测试数据的运行时间是暂定90分钟，超过90分钟的测试结果会导致上传失败并提示用户上传时间不得大于90分钟，用户需要重新上传
* 上传测试结果后，当次的测试结果会保留在/data/local/tmp/路径下，再次开始测试时会覆盖上次的测试结果
* 测试结果上传HMperf平台后，会长期保存，用户可以手动在HMperf平台上进行删除和下载操作
### 报错问题
* ```error: device 'BLT0222907028' not found``` 没有找到这个devices ID的设备，检查输入的devices ID是否正常
* 错误码
```
 '1001':"登录已失效，请重新登录",
 '1010':"没有此用户数据",
 '1050':"token已过期",
 '1051':"token无法解析",
 '1052':"token无效",
 '1055':"HM-TOKEN无效，需要重新登录",
 '2010':"缺少必填参数",
 '2011':"参数验证失败",
 '2020':"文件解密失败",
 '2030':"时长大于90分钟",
 '3001':'文件系统错误',
 '3002':'MQ系统错误',
 '3003':'Redis系统错误',
 '4010':"请求的路径不存在",
 '5001':"服务器内部错误",
```
### 常见问题
**开始测试失败**
* 检查adb是否正常可用，检查手机是否开启开发者模式和允许USB调试
* 检查用户token是否和执行文件在相同的目录下
* 检查用户token是否错误或失效
* 开始测试时需要和后端进行交互，检查网络是否正常

**上传文件失败**
* 检查网络是否正常
* 测试时间是否大于90分钟
* 测试文件是否生成在/data/local/tmp/目录下


